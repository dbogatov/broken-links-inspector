stages:
  - test
  - release

test:
  image: dbogatov/docker-sources:node--14.4-alpine3.12
  stage: test
  script:
    - npm install
    - npm run coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  tags:
    - docker

release:
  image: dbogatov/docker-sources:node--14.4-alpine3.12
  stage: release
  script:
    - |
      cat <<EOT >> .npmrc
      @dbogatov:registry=https://${CI_SERVER_HOST}/api/v4/packages/npm/
      //${CI_SERVER_HOST}/api/v4/packages/npm/:_authToken=${CI_JOB_TOKEN}
      //${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}
      EOT
    - cat .npmrc
    - npm publish
  tags:
    - docker
